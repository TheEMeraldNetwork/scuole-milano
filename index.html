<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Up Your High School - Amore</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Pick Up Your High School - Amore</h1>

    <!-- ATM Calculator -->
    <div class="bg-white shadow-md rounded p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Punti di partenza e calcolo percorso:</h2>
            <div class="mb-4">
                <a href="https://giromilano.atm.it/#/home/calcolapercorso" 
                   target="_blank" 
                   class="text-lg text-green-600 hover:underline">
                    Calcola il tuo percorso su ATM →
                </a>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium mb-2">Casa Marchetti:</h3>
                    <iframe
                        class="w-full h-48 border-2 border-gray-300 rounded"
                        frameborder="0"
                        src="https://www.google.com/maps/embed/v1/place?key=AIzaSyD-G2ym859_c3eQ62ocSYe3SPuvNb6HTf4&q=Via+Leopoldo+Marchetti+2,20141+Milano">
                    </iframe>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Casa Filippetti:</h3>
                    <iframe
                        class="w-full h-48 border-2 border-gray-300 rounded"
                        frameborder="0"
                        src="https://www.google.com/maps/embed/v1/place?key=AIzaSyD-G2ym859_c3eQ62ocSYe3SPuvNb6HTf4&q=Viale+Angelo+Filippetti+3,20122+Milano">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- Open Day Calendar -->
        <div class="bg-white shadow-md rounded p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Open Day Calendar</h2>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="border px-4 py-2 text-left">Liceo</th>
                        <th class="border px-4 py-2 text-left">Data</th>
                        <th class="border px-4 py-2 text-left">Orario</th>
                        <th class="border px-4 py-2 text-left">Prenotato</th>
                        <th class="border px-4 py-2 text-left">Link</th>
                        <th class="border px-4 py-2 text-left">Note</th>
                    </tr>
                </thead>
                <tbody id="openDayData">
                </tbody>
            </table>

            <!-- Add Open Day Form -->
            <div class="mt-4 p-4 border rounded bg-gray-50">
                <h3 class="text-lg font-medium mb-3">Aggiungi Open Day</h3>
                <div class="grid grid-cols-6 gap-4">
                    <select id="schoolSelect" class="border rounded px-2 py-1">
                        <option value="">Seleziona Liceo</option>
                    </select>
                    <input type="date" id="dateInput" class="border rounded px-2 py-1">
                    <input type="time" id="timeInput" class="border rounded px-2 py-1">
                    <input type="text" id="linkInput" placeholder="Link prenotazione" class="border rounded px-2 py-1">
                    <input type="text" id="noteInput" placeholder="Note" class="border rounded px-2 py-1">
                    <button onclick="addOpenDay()" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600">
                        Aggiungi
                    </button>
                </div>
            </div>
        </div>
       
        <!-- Schools Container -->
        <div id="schoolsContainer">
            <!-- Schools will be populated here -->
        </div>

        <button onclick="saveData()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            Salva Dati
        </button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCcPL8F_FAK8FYxDH3UW6xHSmUGQAxlO_Y",
            authDomain: "scuole-milano-16a99.firebaseapp.com",
            projectId: "scuole-milano-16a99",
            storageBucket: "scuole-milano-16a99.firebasestorage.app",
            messagingSenderId: "732123596795",
            appId: "1:732123596795:web:92de1d0d59b61b20276d5e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Schools data
        const schools = [
            { id: 1, name: 'Leone XIII', address: 'Via Leone XIII, 12, 20145 Milano MI' },
            { id: 2, name: 'Einstein', address: 'Via Einstein, 3, 20137 Milano MI' },
            { id: 3, name: 'Vittorini', address: 'Via Donati, 5/7, 20146 Milano MI' },
            { id: 4, name: 'Moreschi', address: 'Via San Michele del Carso, 25, 20144 Milano MI' },
            { id: 5, name: 'Sacro Cuore', address: 'Via Rombon, 78, 20134 Milano MI' },
            { id: 6, name: 'Vittorio Veneto', address: 'Via De Vincenti, 7, 20148 Milano MI' }
        ];

        const voters = ['Mamma', 'Papà', 'Amore'];

        function getVoterColor(voter) {
            switch(voter) {
                case 'Mamma': return 'bg-pink-50';
                case 'Papà': return 'bg-blue-50';
                case 'Amore': return 'bg-purple-50';
                case 'Media': return 'bg-yellow-100';
                default: return '';
            }
        }

        function createSchoolHTML(school) {
            return `
                <div class="bg-white shadow-md rounded p-6 mb-8" id="school-${school.id}">
                    <div class="grid grid-cols-12 gap-4">
                        <!-- School header -->
                        <div class="col-span-12 flex items-center border-b pb-4">
                            <span class="text-2xl font-bold">${school.id}. ${school.name}</span>
                        </div>
                        
                        <!-- Maps -->
                        <div class="col-span-3">
                            <iframe
                                class="w-full h-48 border border-gray-300 rounded mb-2"
                                frameborder="0"
                                src="https://www.google.com/maps/embed/v1/place?key=AIzaSyD-G2ym859_c3eQ62ocSYe3SPuvNb6HTf4&q=${encodeURIComponent(school.address)}">
                            </iframe>
                        </div>

                        <!-- Votes table -->
                        <div class="col-span-9">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-2 text-left">Votante</th>
                                        <th class="px-4 py-2 text-left">Distanza 1</th>
                                        <th class="px-4 py-2 text-left">Distanza 2</th>
                                        <th class="px-4 py-2 text-left">Voto generale</th>
                                        <th class="px-4 py-2 text-left">Impressione</th>
                                        <th class="px-4 py-2 text-left">Inglese</th>
                                        <th class="px-4 py-2 text-left">Scienze</th>
                                        <th class="px-4 py-2 text-left">Mat</th>
                                        <th class="px-4 py-2 text-left">Inter.</th>
                                        <th class="px-4 py-2 text-left">Banco</th>
                                        <th class="px-4 py-2 text-left">Altro</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${voters.map(voter => `
                                        <tr class="${getVoterColor(voter)}">
                                            <td class="px-4 py-2 font-medium">${voter}</td>
                                            <td class="px-4 py-2" contenteditable="true" data-type="numeric" data-school="${school.id}" data-voter="${voter}" data-field="distance1"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-type="numeric" data-school="${school.id}" data-voter="${voter}" data-field="distance2"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-type="numeric" data-school="${school.id}" data-voter="${voter}" data-field="generalVote"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-school="${school.id}" data-voter="${voter}" data-field="impression"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-type="numeric" data-school="${school.id}" data-voter="${voter}" data-field="english"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-type="numeric" data-school="${school.id}" data-voter="${voter}" data-field="science"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-type="numeric" data-school="${school.id}" data-voter="${voter}" data-field="math"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-type="numeric" data-school="${school.id}" data-voter="${voter}" data-field="international"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-type="numeric" data-school="${school.id}" data-voter="${voter}" data-field="desk"></td>
                                            <td class="px-4 py-2" contenteditable="true" data-school="${school.id}" data-voter="${voter}" data-field="other"></td>
                                        </tr>
                                    `).join('')}
                                    <!-- Average row -->
                                    <tr class="${getVoterColor('Media')} border-t-2 border-gray-300">
                                        <td class="px-4 py-2 font-medium">Media</td>
                                        <td class="px-4 py-2" data-average="true"></td>
                                        <td class="px-4 py-2" data-average="true"></td>
                                        <td class="px-4 py-2" data-average="true"></td>
                                        <td class="px-4 py-2">-</td>
                                        <td class="px-4 py-2" data-average="true"></td>
                                        <td class="px-4 py-2" data-average="true"></td>
                                        <td class="px-4 py-2" data-average="true"></td>
                                        <td class="px-4 py-2" data-average="true"></td>
                                        <td class="px-4 py-2" data-average="true"></td>
                                        <td class="px-4 py-2">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function validateNumericInput(element) {
            element.addEventListener('input', function(e) {
                if (this.getAttribute('data-type') === 'numeric') {
                    let value = this.textContent.trim();
                    if (value && !/^\d+$/.test(value)) {
                        alert('Inserire solo numeri interi');
                        this.textContent = '';
                    }
                }
                updateAverages(this);
            });
        }

        function calculateAverage(values) {
            const numbers = values.map(v => parseInt(v)).filter(n => !isNaN(n));
            if (numbers.length === 0) return '';
            return Math.round(numbers.reduce((a, b) => a + b) / numbers.length);
        }

        function updateAverages(changedElement) {
            const schoolId = changedElement.getAttribute('data-school');
            if (!schoolId) return;

            const schoolElement = document.getElementById(`school-${schoolId}`);
            const averageRow = schoolElement.querySelector('tr:last-child');
            const averageCells = averageRow.querySelectorAll('[data-average]');
            
            const voterRows = Array.from(schoolElement.querySelectorAll('tr')).slice(1, -1);
            averageCells.forEach((cell, index) => {
                const values = voterRows.map(row => row.cells[index + 1].textContent.trim());
                cell.textContent = calculateAverage(values);
            });
        }

        async function saveData() {
            try {
                const batch = db.batch();
                const votes = [];

                document.querySelectorAll('[data-school][data-voter]').forEach(cell => {
                    const schoolId = cell.getAttribute('data-school');
                    const voter = cell.getAttribute('data-voter');
                    const field = cell.getAttribute('data-field');
                    const value = cell.textContent.trim();

                    let vote = votes.find(v => v.schoolId === schoolId && v.voter === voter);
                    if (!vote) {
                        vote = { schoolId, voter, docId: `${schoolId}-${voter}` };
                        votes.push(vote);
                    }
                    vote[field] = value;
                });

                votes.forEach(vote => {
                    const docRef = db.collection('votes').doc(vote.docId);
                    batch.set(docRef, vote);
                });

                await batch.commit();
                alert('Dati salvati con successo!');
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Errore nel salvataggio dei dati: ' + error.message);
            }
        }

        async function loadDataFromFirebase() {
            try {
                const snapshot = await db.collection('votes').get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    Object.keys(data).forEach(field => {
                        if (field !== 'schoolId' && field !== 'voter' && field !== 'docId') {
                            const cell = document.querySelector(
                                `[data-school="${data.schoolId}"][data-voter="${data.voter}"][data-field="${field}"]`
                            );
                            if (cell) {
                                cell.textContent = data[field];
                                updateAverages(cell);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Initialize on page load
        window.onload = function() {
            const container = document.getElementById('schoolsContainer');
            container.innerHTML = schools.map(createSchoolHTML).join('');
            
            document.querySelectorAll('[contenteditable="true"]').forEach(validateNumericInput);
            loadDataFromFirebase();
        };
    <script>
            // Aggiungi queste funzioni al tuo JavaScript esistente
            
            // Inizializza il select con le scuole
            function initializeSchoolSelect() {
                const select = document.getElementById('schoolSelect');
                schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    select.appendChild(option);
                });
            }

            // Aggiungi un nuovo Open Day
            async function addOpenDay() {
                const schoolId = document.getElementById('schoolSelect').value;
                const date = document.getElementById('dateInput').value;
                const time = document.getElementById('timeInput').value;
                const link = document.getElementById('linkInput').value;
                const note = document.getElementById('noteInput').value;

                if (!schoolId || !date || !time) {
                    alert('Per favore compila i campi obbligatori (Liceo, Data, Ora)');
                    return;
                }

                try {
                    const docRef = await db.collection('opendays').add({
                        schoolId,
                        schoolName: schools.find(s => s.id === parseInt(schoolId)).name,
                        date,
                        time,
                        link,
                        note,
                        booked: false,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    loadOpenDays();
                    clearOpenDayForm();
                } catch (error) {
                    console.error('Error adding open day:', error);
                    alert('Errore nel salvataggio dell\'open day');
                }
            }

            // Carica gli Open Day da Firebase
            async function loadOpenDays() {
                try {
                    const snapshot = await db.collection('opendays')
                        .orderBy('date')
                        .get();
                    
                    const tbody = document.getElementById('openDayData');
                    tbody.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        const date = new Date(data.date);
                        const formattedDate = date.toLocaleDateString('it-IT');
                        
                        row.innerHTML = `
                            <td class="border px-4 py-2">${data.schoolName}</td>
                            <td class="border px-4 py-2">${formattedDate}</td>
                            <td class="border px-4 py-2">${data.time}</td>
                            <td class="border px-4 py-2">
                                <input type="checkbox" 
                                    ${data.booked ? 'checked' : ''} 
                                    onchange="updateBookingStatus('${doc.id}', this.checked)">
                            </td>
                            <td class="border px-4 py-2">
                                ${data.link ? `<a href="${data.link}" target="_blank" class="text-blue-600 hover:underline">Prenota</a>` : ''}
                            </td>
                            <td class="border px-4 py-2">${data.note || ''}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading open days:', error);
                }
            }

            // Aggiorna lo stato di prenotazione
            async function updateBookingStatus(docId, booked) {
                try {
                    await db.collection('opendays').doc(docId).update({
                        booked: booked
                    });
                } catch (error) {
                    console.error('Error updating booking status:', error);
                    alert('Errore nell\'aggiornamento dello stato di prenotazione');
                }
            }

            // Pulisci il form
            function clearOpenDayForm() {
                document.getElementById('schoolSelect').value = '';
                document.getElementById('dateInput').value = '';
                document.getElementById('timeInput').value = '';
                document.getElementById('linkInput').value = '';
                document.getElementById('noteInput').value = '';
            }

            // Aggiungi queste righe alla funzione window.onload
            window.onload = function() {
                // ... il codice esistente ...
                initializeSchoolSelect();
                loadOpenDays();
            };
        </script>
</body>
</html>

##V_4##
