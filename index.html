<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick Up Your High School - Amore</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Firebase -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Pick Up Your High School - Amore</h1>
        
        <div class="bg-white shadow-md rounded p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Calcola Percorso:</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <strong>Da Casa Marchetti</strong> o <strong>Da Casa Filippetti:</strong>
                    <a href="https://giromilano.atm.it/#/home/calcolapercorso" 
                       target="_blank" 
                       class="ml-4 text-green-600 hover:underline">
                        Calcola percorso ATM
                    </a>
                </div>
            </div>
        </div>

        <div class="bg-white shadow-md rounded p-6 overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-800 text-white">
                        <th class="px-4 py-2 text-left">ID</th>
                        <th class="px-4 py-2 text-left">Liceo</th>
                        <th class="px-4 py-2 text-left">Votante</th>
                        <th class="px-4 py-2 text-left">Distanza 1</th>
                        <th class="px-4 py-2 text-left">Distanza 2</th>
                        <th class="px-4 py-2 text-left">Voto generale</th>
                        <th class="px-4 py-2 text-left">Impressione qualitativa</th>
                        <th class="px-4 py-2 text-left">Inglese</th>
                        <th class="px-4 py-2 text-left">Scienze</th>
                        <th class="px-4 py-2 text-left">Mat</th>
                        <th class="px-4 py-2 text-left">Internazionale</th>
                        <th class="px-4 py-2 text-left">Banco sudato</th>
                        <th class="px-4 py-2 text-left">Altro</th>
                    </tr>
                </thead>
                <tbody id="schoolData">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <button onclick="saveData()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            Salva Dati
        </button>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCcPL8F_FAK8FYxDH3UW6xHSmUGQAxlO_Y",
            authDomain: "scuole-milano-16a99.firebaseapp.com",
            projectId: "scuole-milano-16a99",
            storageBucket: "scuole-milano-16a99.firebasestorage.app",
            messagingSenderId: "732123596795",
            appId: "1:732123596795:web:92de1d0d59b61b20276d5e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Initial schools data
        const initialSchools = [
            { 
                id: 1, 
                name: 'Leone XIII', 
                address: 'Via Leone XIII, 12, 20145 Milano MI',
                voters: ['Mamma', 'Papà', 'Amore']
            },
            { 
                id: 2, 
                name: 'Einstein', 
                address: 'Via Einstein, 3, 20137 Milano MI',
                voters: ['Mamma', 'Papà', 'Amore']
            },
            { 
                id: 3, 
                name: 'Vittorini', 
                address: 'Via Donati, 5/7, 20146 Milano MI',
                voters: ['Mamma', 'Papà', 'Amore']
            },
            { 
                id: 4, 
                name: 'Moreschi', 
                address: 'Viale San Michele del Carso, 25, 20144 Milano MI',
                voters: ['Mamma', 'Papà', 'Amore']
            },
            { 
                id: 5, 
                name: 'Sacro Cuore', 
                address: 'Via Rombon, 78, 20134 Milano MI',
                voters: ['Mamma', 'Papà', 'Amore']
            },
            { 
                id: 6, 
                name: 'Vittorio Veneto', 
                address: 'Via De Vincenti, 7, 20148 Milano MI',
                voters: ['Mamma', 'Papà', 'Amore']
            }
        ];

        function getVoterColor(voter) {
            switch(voter) {
                case 'Mamma': return 'bg-pink-50';
                case 'Papà': return 'bg-blue-50';
                case 'Amore': return 'bg-purple-50';
                case 'Media': return 'bg-yellow-100';
                default: return '';
            }
        }

        function validateNumericInput(cell) {
            cell.addEventListener('input', function(e) {
                if (this.getAttribute('data-type') === 'numeric') {
                    let value = this.textContent.trim();
                    if (value && !/^\d+$/.test(value)) {
                        alert('Inserire solo numeri interi');
                        this.textContent = '';
                    }
                }
            });
        }

        function calculateAverage(values) {
            const validValues = values.filter(v => v !== '');
            if (validValues.length === 0) return '';
            const sum = validValues.reduce((a, b) => a + parseInt(b), 0);
            return Math.round(sum / validValues.length);
        }

        function initializeTable() {
            const tbody = document.getElementById('schoolData');
            tbody.innerHTML = initialSchools.map(school => {
                let rows = '';
                
                // Add voter rows
                school.voters.forEach((voter, index) => {
                    rows += `
                        <tr class="${getVoterColor(voter)} border-t">
                            <td class="px-4 py-2">${school.id}</td>
                            <td class="px-4 py-2">${index === 0 ? school.name : ''}</td>
                            <td class="px-4 py-2 font-medium">${voter}</td>
                            <td class="px-4 py-2" contenteditable="true" data-type="numeric"></td>
                            <td class="px-4 py-2" contenteditable="true" data-type="numeric"></td>
                            <td class="px-4 py-2" contenteditable="true" data-type="numeric"></td>
                            <td class="px-4 py-2" contenteditable="true"></td>
                            <td class="px-4 py-2" contenteditable="true" data-type="numeric"></td>
                            <td class="px-4 py-2" contenteditable="true" data-type="numeric"></td>
                            <td class="px-4 py-2" contenteditable="true" data-type="numeric"></td>
                            <td class="px-4 py-2" contenteditable="true" data-type="numeric"></td>
                            <td class="px-4 py-2" contenteditable="true" data-type="numeric"></td>
                            <td class="px-4 py-2" contenteditable="true"></td>
                        </tr>
                    `;
                });

                // Add average row
                rows += `
                    <tr class="${getVoterColor('Media')} border-t-2 border-gray-300">
                        <td class="px-4 py-2">${school.id}</td>
                        <td class="px-4 py-2"></td>
                        <td class="px-4 py-2 font-medium">Media</td>
                        <td class="px-4 py-2" data-average="true"></td>
                        <td class="px-4 py-2" data-average="true"></td>
                        <td class="px-4 py-2" data-average="true"></td>
                        <td class="px-4 py-2"></td>
                        <td class="px-4 py-2" data-average="true"></td>
                        <td class="px-4 py-2" data-average="true"></td>
                        <td class="px-4 py-2" data-average="true"></td>
                        <td class="px-4 py-2" data-average="true"></td>
                        <td class="px-4 py-2" data-average="true"></td>
                        <td class="px-4 py-2"></td>
                    </tr>
                    <tr class="h-4"></tr>
                `;

                return rows;
            }).join('');

            // Add numeric validation to editable cells
            document.querySelectorAll('[contenteditable="true"]').forEach(validateNumericInput);

            // Add input event listeners to update averages
            document.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                cell.addEventListener('input', updateAverages);
            });
        }

        function updateAverages() {
            initialSchools.forEach(school => {
                const schoolRows = Array.from(document.querySelectorAll(`tr`))
                    .filter(row => row.querySelector('td').textContent === school.id.toString());
                
                const voterRows = schoolRows.slice(0, 3);
                const averageRow = schoolRows[3];

                if (averageRow) {
                    const averageCells = averageRow.querySelectorAll('[data-average="true"]');
                    averageCells.forEach((cell, colIndex) => {
                        const values = voterRows.map(row => 
                            row.querySelectorAll('td')[colIndex + 3].textContent.trim());
                        cell.textContent = calculateAverage(values);
                    });
                }
            });
        }

        async function saveData() {
            try {
                const batch = db.batch();
                const rows = document.querySelectorAll('#schoolData tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const voter = cells[2].textContent;
                    if (voter !== 'Media') {
                        const docRef = db.collection('votes').doc(`${cells[0].textContent}-${voter}`);
                        batch.set(docRef, {
                            id: cells[0].textContent,
                            name: cells[1].textContent || initialSchools[parseInt(cells[0].textContent) - 1].name,
                            voter: voter,
                            distance1: cells[3].textContent,
                            distance2: cells[4].textContent,
                            generalVote: cells[5].textContent,
                            impression: cells[6].textContent,
                            english: cells[7].textContent,
                            science: cells[8].textContent,
                            math: cells[9].textContent,
                            international: cells[10].textContent,
                            desk: cells[11].textContent,
                            other: cells[12].textContent
                        });
                    }
                });

                await batch.commit();
                alert('Dati salvati con successo!');
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Errore nel salvataggio dei dati');
            }
        }

        async function loadDataFromFirebase() {
            try {
                const snapshot = await db.collection('votes').get();
                const savedData = [];
                snapshot.forEach(doc => {
                    savedData.push(doc.data());
                });

                if (savedData.length > 0) {
                    const rows = document.querySelectorAll('#schoolData tr');
                    savedData.forEach((saved) => {
                        const row = Array.from(rows).find(row => {
                            const cells = row.querySelectorAll('td');
                            return cells[0].textContent === saved.id && 
                                   cells[2].textContent === saved.voter;
                        });

                        if (row) {
                            const cells = row.querySelectorAll('td');
                            cells[3].textContent = saved.distance1;
                            cells[4].textContent = saved.distance2;
                            cells[5].textContent = saved.generalVote;
                            cells[6].textContent = saved.impression;
                            cells[7].textContent = saved.english;
                            cells[8].textContent = saved.science;
                            cells[9].textContent = saved.math;
                            cells[10].textContent = saved.international;
                            cells[11].textContent = saved.desk;
                            cells[12].textContent = saved.other;
                        }
                    });
                    updateAverages();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Initialize on page load
        window.onload = function() {
            initializeTable();
            loadDataFromFirebase();
        };
    </script>
</body>
</html>
##V_3##
